<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PCC 1 FAENA</title>

  <style>
    :root{
      --bg:#f3f4f6; --card:#fff; --text:#111; --border:#d0d7de;
      --blue:#2563eb; --red:#ef4444; --sky:#0ea5e9; --green:#16a34a; --gray:#64748b;
      --muted:#6b7280;
    }
    body{ margin:0; padding:10px; font-family:Arial, sans-serif; background:var(--bg); color:var(--text); }

    .encabezado table{ width:100%; border-collapse:collapse; background:#fff; margin-bottom:10px; }
    .encabezado td{ border:2px solid #000; padding:8px; vertical-align:middle; }
    .logo{ width:20%; text-align:center; background:#f3f6ff; }
    .logo img{ max-width:140px; max-height:70px; object-fit:contain; display:block; margin:0 auto; }
    .titulo{ width:60%; text-align:center; font-size:13px; line-height:1.2; }
    .titulo span{ color:#0b3d91; font-weight:700; }
    .info{ width:20%; text-align:center; background:#cfefff; font-size:12px; line-height:1.25; }

    .tabs{ display:flex; gap:6px; margin-bottom:10px; }
    .tab-btn{
      flex:1; padding:12px; cursor:pointer; font-weight:900;
      border:none; border-radius:12px;
      background:#cbd5e1; color:#334155;
    }
    .tab-btn.active{ background:var(--blue); color:#fff; }
    .tab-content{ display:none; }
    .tab-content.active{ display:block; }

    .toolbar{ display:flex; gap:8px; flex-wrap:wrap; margin:10px 0; }
    .toolbar button{
      padding:10px 12px; border:none; border-radius:12px; cursor:pointer; font-weight:900; color:#fff;
      background:var(--blue);
    }
    .toolbar .sky{ background:var(--sky); }
    .toolbar .green{ background:var(--green); }
    .toolbar .red{ background:var(--red); }

    .card-entry{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-bottom:10px;
    }
    .row{ display:flex; flex-direction:column; gap:6px; }
    label{ font-size:10px; font-weight:900; color:var(--muted); text-transform:uppercase; }

    input, select, textarea{
      width:100%; box-sizing:border-box;
      padding:10px; border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      font-size:14px;
    }
    textarea{ resize:vertical; min-height:70px; }

    .switchline{
      display:flex; align-items:center; gap:8px;
      margin-top:6px;
    }

    .table-container{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      overflow:auto;
    }
    table{ width:100%; border-collapse:collapse; }
    th, td{ border-bottom:1px solid var(--border); padding:10px; text-align:center; font-size:13px; vertical-align:top; }
    th{ position:sticky; top:0; background:#f8fafc; color:var(--muted); font-weight:900; }

    td.left{ text-align:left; }
    .mini{
      border:none; border-radius:10px; padding:8px 10px; cursor:pointer;
      font-weight:900; color:#fff; background:#64748b;
    }
    .mini.red{ background:var(--red); }
    .mini:disabled{ opacity:.35; cursor:not-allowed; }

    .cell-inp{ padding:6px 8px; border-radius:10px; border:1px solid var(--border); font-size:13px; }
    .cell-sel{ padding:6px 8px; border-radius:10px; border:1px solid var(--border); font-size:13px; background:#fff; }

    /* PRINT */
    #print-replica{ display:none; }
    @media print{
      .tabs, .toolbar, .card-entry, .table-container { display:none !important; }
      #print-replica{ display:block !important; }
      body > .encabezado{ display:none !important; }
      @page{ size:A4 landscape; margin:0.6cm; }

      .p-table{ width:100%; border-collapse:collapse; table-layout:fixed; }
      .p-table th, .p-table td{ border:1px solid #000; padding:4px; font-size:9pt; vertical-align:top; }
      .p-table th{ background:#eee; }
      .p-title{ text-align:center; font-weight:900; margin:8px 0 10px; }

      .encabezado-print table{ width:100%; border-collapse:collapse; margin-bottom:8px; }
      .encabezado-print td{ border:2px solid #000; padding:6px; vertical-align:middle; }
      .encabezado-print .logo{ width:20%; text-align:center; }
      .encabezado-print .logo img{ max-width:130px; max-height:60px; object-fit:contain; }
      .encabezado-print .titulo{ width:60%; text-align:center; font-size:12px; }
      .encabezado-print .info{ width:20%; text-align:center; font-size:11px; background:#cfefff; }

      .p-firmas{
        margin-top:14px;
        display:flex;
        gap:20px;
        justify-content:space-between;
        align-items:flex-end;
        font-size:10pt;
      }
      .p-firma-box{
        width:48%;
        border:1px solid #000;
        padding:10px;
      }
      .p-line{
        border-bottom:1px solid #000;
        height:18px;
        margin:12px 0 6px;
      }
      .p-small{ font-size:9pt; }
      .p-right{ text-align:right; }
    }
  </style>
</head>

<body>
  <div class="encabezado">
    <table>
      <tr>
        <td class="logo"><img id="logoImg" src="logo.jpg" alt="Logo"></td>
        <td class="titulo">
          <strong>SISTEMA DE GESTI√ìN DE CALIDAD</strong><br>
          INSPECCI√ìN DE CARCASAS ANTES DEL LAVADO<br>
          <span>PCC 1 FAENA</span>
        </td>
        <td class="info">
          RG-HCCP - PCC - 307/1<br>
          Emisi√≥n: 23/02/2026<br>
          Rev. 12
        </td>
      </tr>
    </table>
  </div>

  <div class="toolbar">
    <button class="sky" type="button" id="btnHora">‚è±Ô∏è Hora</button>
    <button type="button" id="btnPDF">üñ®Ô∏è PDF</button>
    <button class="green" type="button" id="btnFinalizar">‚úÖ Finalizar d√≠a</button>
    <button class="red" type="button" id="btnBorrar">üóëÔ∏è Borrar d√≠a</button>
  </div>

  <div class="card-entry">
    <div class="row">
      <label>Fecha (d√≠a de registro)</label>
      <input type="date" id="dayDate">
    </div>

    <div class="row">
      <label>Garr√≥n</label>
      <input id="inG" inputmode="numeric" placeholder="(auto)">
    </div>

    <div class="row">
      <label>Hora</label>
      <input type="time" id="inH" step="60">
      <div class="switchline">
        <!-- Checkbox discreto (sin texto) -->
        <input type="checkbox" id="lockMode" title=" ">
      </div>
    </div>

    <div class="row">
      <label>Desv√≠o (0/1)</label>
      <select id="inB">
        <option value="0">0</option>
        <option value="1">1</option>
      </select>
    </div>

    <div class="row">
      <label>Resp</label>
      <select id="inR">
        <option value="">-</option>
        <option value="MQ">MQ</option>
        <option value="MD">MD</option>
        <option value="WC">WC</option>
        <option value="DE">DE</option>
        <option value="AA">AA</option>
      </select>

      <button type="button" id="btnAgregar" class="mini" style="background: var(--green); margin-top:8px;">+ CARGAR</button>
    </div>
  </div>

  <div class="tabs">
    <button class="tab-btn active" data-tab="tab1">REGISTRO</button>
    <button class="tab-btn" data-tab="tab2">ACCIONES</button>
    <button class="tab-btn" data-tab="tab3">D√çAS FINALIZADOS</button>
  </div>

  <!-- TAB 1 -->
  <div id="tab1" class="tab-content active">
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Garr√≥n</th>
            <th>Hora</th>
            <th>0/1</th>
            <th>Resp</th>
            <th id="thBorrar" style="width:110px;">Borrar</th>
          </tr>
        </thead>
        <tbody id="tbReg"></tbody>
      </table>
    </div>
  </div>

  <!-- TAB 2 -->
  <div id="tab2" class="tab-content">
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Garr√≥n / Lado / Ubicaci√≥n</th>
            <th style="width:90px;">Hora</th>
            <th style="width:130px;">Fecha</th>
            <th>Descripci√≥n del desv√≠o</th>
            <th>Acci√≥n correctiva</th>
            <th>Hora/ corregido SI/NO disposici√≥n del producto</th>
            <th>Restablecimiento de control del proceso</th>
            <th>Acci√≥n preventiva</th>
            <th style="width:140px;">Encargado</th>
          </tr>
        </thead>
        <tbody id="tbAcc"></tbody>
      </table>
    </div>
  </div>

  <!-- TAB 3 -->
  <div id="tab3" class="tab-content">
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th style="width:150px;">Fecha</th>
            <th style="width:110px;">Registros</th>
            <th style="width:140px;">Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tbFinal"></tbody>
      </table>
    </div>
  </div>

  <div id="print-replica"></div>

<script>
  // ====== STORAGE KEYS ======
  const LS_DAYDATE = "pcc1_daydate_v11";
  const LS_DAY     = "pcc1_day_v11";
  const LS_FINAL   = "pcc1_final_v11";
  const LS_LOCK    = "pcc1_lock_v11";

  let data = [];
  let finalizados = [];
  let dayDate = "";

  const elLogo = document.getElementById("logoImg");
  const btnHora = document.getElementById("btnHora");
  const btnPDF = document.getElementById("btnPDF");
  const btnFinalizar = document.getElementById("btnFinalizar");
  const btnBorrar = document.getElementById("btnBorrar");
  const btnAgregar = document.getElementById("btnAgregar");

  const inpDayDate = document.getElementById("dayDate");
  const inG = document.getElementById("inG");
  const inH = document.getElementById("inH");
  const inB = document.getElementById("inB");
  const inR = document.getElementById("inR");
  const lockMode = document.getElementById("lockMode");

  const tbReg = document.getElementById("tbReg");
  const tbAcc = document.getElementById("tbAcc");
  const tbFinal = document.getElementById("tbFinal");
  const thBorrar = document.getElementById("thBorrar");

  // ====== LOGO FALLBACKS ======
  (function(){
    if(!elLogo) return;
    const candidates = ["logo.jpg","logo.jpeg","logo.png","logo.jpg.jpeg","LOGO.jpg","LOGO.JPG","Logo.jpg"];
    let i=0;
    elLogo.onerror = function(){
      i++;
      if(i < candidates.length) elLogo.src = candidates[i];
      else { elLogo.style.display="none"; elLogo.parentNode.innerHTML="<b>LOGO</b>"; }
    };
    elLogo.src = candidates[0];
  })();

  // ====== HELPERS ======
  function esc(s){
    s = String(s == null ? "" : s);
    return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  }
  function escAttr(s){
    s = String(s == null ? "" : s);
    return s.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  }
  function nowHHMM(){
    const d = new Date();
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    return hh + ":" + mm;
  }
  function todayISO(){ return new Date().toISOString().slice(0,10); }
  function capTime(){ inH.value = nowHHMM(); }
  function isLocked(){ return !!lockMode.checked; }

  // ====== LOAD/SAVE ======
  function loadAll(){
    try{
      data = JSON.parse(localStorage.getItem(LS_DAY) || "[]");
      if(!Array.isArray(data)) data = [];
    }catch(e){ data = []; }

    try{
      finalizados = JSON.parse(localStorage.getItem(LS_FINAL) || "[]");
      if(!Array.isArray(finalizados)) finalizados = [];
    }catch(e){ finalizados = []; }

    lockMode.checked = (localStorage.getItem(LS_LOCK) === "1");

    dayDate = localStorage.getItem(LS_DAYDATE) || "";
    if(!dayDate) dayDate = todayISO();
    inpDayDate.value = dayDate;
  }
  function saveDay(){ localStorage.setItem(LS_DAY, JSON.stringify(data)); }
  function saveFinal(){ localStorage.setItem(LS_FINAL, JSON.stringify(finalizados)); }
  function saveDayDate(){ localStorage.setItem(LS_DAYDATE, dayDate); }

  // ====== GARRON AUTO ======
  function nextGarronNumber(){
    if(isLocked()) return data.length + 1;
    let maxG = 0;
    for(const d of data){
      const n = Number(d.g);
      if(Number.isFinite(n) && n > maxG) maxG = n;
    }
    return maxG + 1;
  }
  function updateGarron(){
    if(document.activeElement === inG) return;
    if((inG.value || "").trim() === ""){
      inG.value = String(nextGarronNumber());
    }
  }

  function setLockUI(){
    const locked = isLocked();

    // Registro bloqueado
    inpDayDate.disabled = locked;
    inG.disabled = locked;
    inH.disabled = locked;

    // Desv√≠o + Resp siempre editables
    inB.disabled = false;
    inR.disabled = false;

    // Oculta columna borrar en modo tildado
    thBorrar.style.display = locked ? "none" : "";

    if(locked){
      capTime();
      inG.value = "1";
    }else{
      inG.value = "";
      updateGarron();
    }

    renderAll();
  }

  // ====== EVENTS ======
  inpDayDate.addEventListener("change", function(){
    dayDate = inpDayDate.value || todayISO();
    saveDayDate();
    // Si quer√©s que acciones existentes sin fecha tomen la nueva fecha al cambiar d√≠a:
    // data.forEach(d=>{ if(!d.fechaAcc) d.fechaAcc = dayDate; }); saveDay();
    renderAll();
  });

  document.querySelectorAll(".tab-btn").forEach(btn=>{
    btn.addEventListener("click", function(){
      document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
      document.querySelectorAll(".tab-content").forEach(t=>t.classList.remove("active"));
      this.classList.add("active");
      document.getElementById(this.getAttribute("data-tab")).classList.add("active");
      if(this.getAttribute("data-tab")==="tab3") renderFinalizados();
    });
  });

  btnHora.addEventListener("click", capTime);
  btnPDF.addEventListener("click", imprimirTodo);
  btnFinalizar.addEventListener("click", finalizarDia);

  lockMode.addEventListener("change", function(){
    localStorage.setItem(LS_LOCK, lockMode.checked ? "1" : "0");
    setLockUI();
    if(isLocked()) capTime();
  });

  btnBorrar.addEventListener("click", function(){
    if(!confirm("¬øBorrar todo el d√≠a actual en este dispositivo?")) return;
    data = [];
    saveDay();
    updateGarron();
    renderAll();
  });

  btnAgregar.addEventListener("click", addRow);

  // ====== CRUD ======
  function addRow(){
    const resp = (inR.value || "").trim().toUpperCase();
    if(!resp){ alert("Falta RESP"); return; }

    if(isLocked()) capTime();

    let gNum = Number((inG.value || "").trim());
    if(!Number.isFinite(gNum) || gNum <= 0) gNum = nextGarronNumber();

    data.push({
      g: gNum,
      h: inH.value || "",
      b: inB.value || "0",
      r: resp,

      // acciones:
      lado:"",
      ubicacion:"",
      // ‚úÖ FECHA AUTOM√ÅTICA: se setea con la fecha del registro
      fechaAcc: (dayDate || todayISO()),
      descDesvio:"",
      accionCorrectiva:"",
      horaCorregido:"",
      restablecimiento:"",
      accionPreventiva:"",
      encargado:""
    });

    saveDay();
    inG.value = "";
    updateGarron();
    inR.value = "";
    if(isLocked()) capTime();
    renderAll();
  }

  // Registro: editar solo cuando NO est√° tildado
  window.updRow = function(idx, field, value){
    if(isLocked()) return;

    if(field === "g"){
      const n = Number(value);
      if(!Number.isFinite(n) || n <= 0) return;
      data[idx].g = n;
    } else if(field === "b"){
      if(value !== "0" && value !== "1") return;
      data[idx].b = value;
    } else if(field === "r"){
      data[idx].r = String(value || "").trim().toUpperCase();
    } else if(field === "h"){
      data[idx].h = value || "";
    }
    saveDay();
    renderAll();
  };

  window.deleteRow = function(idx){
    if(isLocked()) return;
    if(!confirm("¬øBorrar esta fila?")) return;
    data.splice(idx,1);
    saveDay();
    updateGarron();
    renderAll();
  };

  // Acciones SIEMPRE editables (aunque est√© tildado)
  window.saveField = function(idx, field, value){
    data[idx][field] = value;
    saveDay();
  };

  // ====== RENDER ======
  function renderRegistro(){
    const locked = isLocked();

    tbReg.innerHTML = data.map((d,idx)=>{
      if(locked){
        return `
          <tr>
            <td>${esc(d.g)}</td>
            <td>${esc(d.h)}</td>
            <td>${esc(d.b)}</td>
            <td>${esc(d.r)}</td>
          </tr>
        `;
      }

      return `
        <tr>
          <td><input class="cell-inp" inputmode="numeric" value="${escAttr(d.g)}" oninput="updRow(${idx},'g',this.value)"></td>
          <td><input class="cell-inp" type="time" step="60" value="${escAttr(d.h)}" onchange="updRow(${idx},'h',this.value)"></td>
          <td>
            <select class="cell-sel" onchange="updRow(${idx},'b',this.value)">
              <option value="0" ${d.b==="0"?"selected":""}>0</option>
              <option value="1" ${d.b==="1"?"selected":""}>1</option>
            </select>
          </td>
          <td>
            <select class="cell-sel" onchange="updRow(${idx},'r',this.value)">
              <option value="" ${!d.r?"selected":""}>-</option>
              <option value="MQ" ${d.r==="MQ"?"selected":""}>MQ</option>
              <option value="MD" ${d.r==="MD"?"selected":""}>MD</option>
              <option value="WC" ${d.r==="WC"?"selected":""}>WC</option>
              <option value="DE" ${d.r==="DE"?"selected":""}>DE</option>
              <option value="AA" ${d.r==="AA"?"selected":""}>AA</option>
            </select>
          </td>
          <td style="display:${locked?"none":""}">
            <button class="mini red" onclick="deleteRow(${idx})">üóëÔ∏è</button>
          </td>
        </tr>
      `;
    }).join("");
  }

  function renderAcciones(){
    const devs = data.map((d,idx)=>({d,idx})).filter(x=>x.d.b==="1");

    if(devs.length === 0){
      tbAcc.innerHTML = `<tr><td colspan="9" style="text-align:left;color:#64748b;">Sin desv√≠os (1).</td></tr>`;
      return;
    }

    tbAcc.innerHTML = devs.map(x=>{
      const d = x.d, idx = x.idx;

      return `
        <tr>
          <td class="left">
            <div><b>Garr√≥n ${esc(d.g)}</b></div>

            <div style="margin-top:6px;">
              <select onchange="saveField(${idx},'lado',this.value)">
                <option value="">Lado</option>
                <option value="Izquierdo" ${d.lado==="Izquierdo"?"selected":""}>Izquierdo</option>
                <option value="Derecho" ${d.lado==="Derecho"?"selected":""}>Derecho</option>
              </select>
            </div>

            <div style="margin-top:6px;">
              <select onchange="saveField(${idx},'ubicacion',this.value)">
                <option value="">Ubicaci√≥n</option>
                <option value="Garr√≥n" ${d.ubicacion==="Garr√≥n"?"selected":""}>Garr√≥n</option>
                <option value="Culata" ${d.ubicacion==="Culata"?"selected":""}>Culata</option>
                <option value="Nalga-Bola de lomo" ${d.ubicacion==="Nalga-Bola de lomo"?"selected":""}>Nalga-Bola de lomo</option>
                <option value="Bifes-cuadril" ${d.ubicacion==="Bifes-cuadril"?"selected":""}>Bifes-cuadril</option>
                <option value="Pecho-Matambre-Ijada" ${d.ubicacion==="Pecho-Matambre-Ijada"?"selected":""}>Pecho-Matambre-Ijada</option>
                <option value="Lomo-costillas" ${d.ubicacion==="Lomo-costillas"?"selected":""}>Lomo-costillas</option>
                <option value="Brazuelo-Cogote" ${d.ubicacion==="Brazuelo-Cogote"?"selected":""}>Brazuelo-Cogote</option>
                <option value="Marucha-Paleta" ${d.ubicacion==="Marucha-Paleta"?"selected":""}>Marucha-Paleta</option>
                <option value="Vacio-Entra√±a" ${d.ubicacion==="Vacio-Entra√±a"?"selected":""}>Vacio-Entra√±a</option>
              </select>
            </div>
          </td>

          <td>${esc(d.h || "")}</td>

          <td>
            <!-- ‚úÖ si alguna fila vieja est√° vac√≠a, muestra la fecha del registro -->
            <input type="date" value="${escAttr(d.fechaAcc || dayDate || '')}"
                   onchange="saveField(${idx},'fechaAcc',this.value)">
          </td>

          <td>
            <textarea oninput="saveField(${idx},'descDesvio',this.value)">${esc(d.descDesvio || '')}</textarea>
          </td>

          <td>
            <textarea oninput="saveField(${idx},'accionCorrectiva',this.value)">${esc(d.accionCorrectiva || '')}</textarea>
          </td>

          <td>
            <input value="${escAttr(d.horaCorregido || '')}"
                   placeholder="Hora / Corregido SI/NO / disposici√≥n"
                   oninput="saveField(${idx},'horaCorregido',this.value)">
          </td>

          <td>
            <textarea oninput="saveField(${idx},'restablecimiento',this.value)">${esc(d.restablecimiento || '')}</textarea>
          </td>

          <td>
            <textarea oninput="saveField(${idx},'accionPreventiva',this.value)">${esc(d.accionPreventiva || '')}</textarea>
          </td>

          <td>
            <select onchange="saveField(${idx},'encargado',this.value)">
              <option value="">Encargado</option>
              <option value="Agustin Bravo" ${d.encargado==="Agustin Bravo"?"selected":""}>Agustin Bravo</option>
              <option value="Juan Alegre" ${d.encargado==="Juan Alegre"?"selected":""}>Juan Alegre</option>
              <option value="Carlos Esquivel" ${d.encargado==="Carlos Esquivel"?"selected":""}>Carlos Esquivel</option>
            </select>
          </td>
        </tr>
      `;
    }).join("");
  }

  function renderFinalizados(){
    if(!finalizados.length){
      tbFinal.innerHTML = `<tr><td colspan="4" style="text-align:left; color:#64748b;">Sin d√≠as finalizados.</td></tr>`;
      return;
    }

    tbFinal.innerHTML = finalizados.map((d,i)=>{
      const estado = "OK";
      const btnEditar = d.locked
        ? `<button class="mini" disabled>Editar</button>`
        : `<button class="mini" onclick="cargarDia(${i})">Editar</button>`;

      return `
        <tr>
          <td><b>${esc(d.fecha)}</b></td>
          <td>${(d.datos||[]).length}</td>
          <td>${esc(estado)}</td>
          <td class="left">
            ${btnEditar}
            <button class="mini" onclick="pdfDia(${i})">PDF</button>
            <button class="mini red" onclick="borrarDia(${i})">Borrar</button>
          </td>
        </tr>
      `;
    }).join("");
  }

  function renderAll(){
    renderRegistro();
    renderAcciones();
  }

  // ====== FINALIZAR / DIAS ======
  function finalizarDia(){
    if(!data.length){ alert("No hay registros."); return; }
    if(!dayDate){ alert("Falta la fecha del d√≠a."); return; }

    const snap = {
      fecha: dayDate,
      locked: isLocked(),
      savedAt: new Date().toISOString(),
      datos: JSON.parse(JSON.stringify(data))
    };

    finalizados = finalizados.filter(x=>x.fecha !== dayDate);
    finalizados.unshift(snap);
    saveFinal();
    alert("D√≠a guardado ‚úÖ");
    renderFinalizados();
  }

  window.cargarDia = function(i){
    if(!finalizados[i]) return;
    if(finalizados[i].locked){ alert("No editable."); return; }
    data = JSON.parse(JSON.stringify(finalizados[i].datos || []));
    dayDate = finalizados[i].fecha || todayISO();
    inpDayDate.value = dayDate;
    saveDayDate();
    saveDay();
    inG.value = "";
    updateGarron();
    renderAll();
    document.querySelector('.tab-btn[data-tab="tab1"]').click();
  };

  window.borrarDia = function(i){
    if(!finalizados[i]) return;
    if(!confirm("¬øBorrar d√≠a finalizado?")) return;
    finalizados.splice(i,1);
    saveFinal();
    renderFinalizados();
  };

  window.pdfDia = function(i){
    if(!finalizados[i]) return;
    const prevData = data, prevDate = dayDate;
    data = JSON.parse(JSON.stringify(finalizados[i].datos || []));
    dayDate = finalizados[i].fecha || prevDate;
    imprimirTodo();
    data = prevData;
    dayDate = prevDate;
  };

  // ====== PRINT HEADERS ======
  function headerPrintHTML(){
    return `
      <div class="encabezado-print">
        <table><tr>
          <td class="logo"><img src="logo.jpg" onerror="this.onerror=null;this.src='logo.png';" alt="Logo"></td>
          <td class="titulo">
            <strong>SISTEMA DE GESTI√ìN DE CALIDAD</strong><br>
            INSPECCI√ìN DE CARCASAS ANTES DEL LAVADO<br>
            <span style="font-weight:900; color:#0b3d91;">PCC 1 FAENA</span>
          </td>
          <td class="info">RG-HCCP - PCC - 307/1<br>Emisi√≥n: 23/02/2026<br>Rev. 12</td>
        </tr></table>
      </div>
    `;
  }

  // ‚úÖ Encabezado especial SOLO para ACCIONES (PDF)
  function headerPrintAccionesHTML(){
    return `
      <div class="encabezado-print">
        <table><tr>
          <td class="logo"><img src="logo.jpg" onerror="this.onerror=null;this.src='logo.png';" alt="Logo"></td>
          <td class="titulo">
            <strong>SISTEMA DE GESTI√ìN DE CALIDAD</strong><br>
            DESCRIPCI√ìN DEL DESV√çO<br>
            <span style="font-weight:900; color:#0b3d91;">HACCP - PCC1 FAENA</span>
          </td>
          <td class="info">RG-HCCP - PCC - 307/1<br>Emisi√≥n: 23/02/2026<br>Rev. 12</td>
        </tr></table>
      </div>
    `;
  }

  function firmasHTML(){
    const fecha = new Date().toLocaleDateString("es-AR");
    return `
      <div class="p-firmas">
        <div class="p-firma-box"><div><b>Analista</b></div><div class="p-line"></div><div class="p-small">Aclaraci√≥n:</div></div>
        <div class="p-firma-box"><div><b>Verificador</b></div><div class="p-line"></div><div class="p-small">Aclaraci√≥n:</div></div>
      </div>
      <div class="p-right p-small" style="margin-top:8px;"><b>Fecha impresi√≥n:</b> ${esc(fecha)}</div>
    `;
  }

  function imprimirTodo(){
    let html = '<div class="print-page">';

    // REGISTRO
    html += headerPrintHTML();
    html += `<div class="p-title">REGISTRO PCC 1 - ${esc(dayDate || "")}</div>`;
    html += `
      <table class="p-table">
        <thead>
          <tr><th>Garr√≥n</th><th>Hora</th><th>0/1</th><th>Resp</th></tr>
        </thead>
        <tbody>
          ${data.map(d=>`
            <tr>
              <td>${esc(d.g)}</td>
              <td>${esc(d.h)}</td>
              <td>${esc(d.b)}</td>
              <td>${esc(d.r)}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;

    // ACCIONES
    const devs = data.filter(d=>d.b==="1");

    // ‚úÖ Encabezado especial para acciones
    html += headerPrintAccionesHTML();
    html += `<div class="p-title">DESCRIPCI√ìN DEL DESV√çO</div>`;
    html += `
      <table class="p-table">
        <thead>
          <tr>
            <th>Garr√≥n</th>
            <th>Lado</th>
            <th>Ubicaci√≥n</th>
            <th>Hora</th>
            <th>Fecha</th>
            <th>Descripci√≥n del desv√≠o</th>
            <th>Acci√≥n correctiva</th>
            <th>Hora/ corregido SI/NO disposici√≥n del producto</th>
            <th>Restablecimiento de control del proceso</th>
            <th>Acci√≥n preventiva</th>
            <th>Encargado</th>
          </tr>
        </thead>
        <tbody>
          ${devs.map(d=>`
            <tr>
              <td>${esc(d.g)}</td>
              <td>${esc(d.lado)}</td>
              <td>${esc(d.ubicacion)}</td>
              <td>${esc(d.h)}</td>
              <td>${esc(d.fechaAcc)}</td>
              <td>${esc(d.descDesvio)}</td>
              <td>${esc(d.accionCorrectiva)}</td>
              <td>${esc(d.horaCorregido)}</td>
              <td>${esc(d.restablecimiento)}</td>
              <td>${esc(d.accionPreventiva)}</td>
              <td>${esc(d.encargado)}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;

    html += firmasHTML();
    html += '</div>';

    document.getElementById("print-replica").innerHTML = html;
    setTimeout(()=>window.print(), 200);
  }

  // ====== INIT ======
  loadAll();
  capTime();
  updateGarron();
  setLockUI();
  renderAll();
  renderFinalizados();
</script>
</body>
</html>